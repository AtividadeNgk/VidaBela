<!DOCTYPE html>
<html lang="pt-BR">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Gerenciamento de Bots - Painel Admin</title>
<style>
    /* DARK MODE - VARI√ÅVEIS DE CORES */
    :root {
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --bg-card: #242424;
        --text-primary: #e0e0e0;
        --text-secondary: #b0b0b0;
        --border-color: #3a3a3a;
        --shadow: rgba(0,0,0,0.5);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: Arial, sans-serif;
        min-height: 100vh;
    }
    
    .header {
        background: var(--bg-secondary);
        padding: 20px;
        box-shadow: 0 2px 4px var(--shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .header h1 {
        color: #4a9eff;
        font-size: 24px;
    }
    
    .back-btn {
        background: #2196F3;
        color: white;
        text-decoration: none;
        padding: 10px 20px;
        border-radius: 4px;
        transition: background 0.3s;
    }
    
    .back-btn:hover {
        background: #1976D2;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: var(--bg-card);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--shadow);
        text-align: center;
        border: 1px solid var(--border-color);
    }
    
    .stat-card h2 {
        color: #4a9eff;
        font-size: 32px;
        margin-bottom: 10px;
    }
    
    .stat-card p {
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    .controls {
        background: var(--bg-card);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--shadow);
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
        border: 1px solid var(--border-color);
    }
    
    .search-box {
        flex: 1;
        min-width: 300px;
    }
    
    .search-box input {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 14px;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    .search-box input:focus {
        outline: none;
        border-color: #2196F3;
    }

    .search-box input::placeholder {
        color: var(--text-secondary);
    }

    /* Tooltip de Preview de Texto */
    .text-preview-tooltip {
        position: fixed;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 20px var(--shadow);
        width: 500px;
        max-height: 70vh;
        overflow-y: auto;
        z-index: 5000;
        font-size: 13px;
        color: var(--text-primary);
    }

    .preview-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 15px;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .preview-title {
        font-weight: bold;
        font-size: 14px;
    }

    .preview-close {
        cursor: pointer;
        font-size: 20px;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.3s;
    }

    .preview-close:hover {
        background: rgba(255,255,255,0.2);
    }

    .preview-body {
        padding: 15px;
        max-height: calc(70vh - 50px);
        overflow-y: auto;
    }

    .preview-section {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }

    .preview-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .preview-section-title {
        font-weight: bold;
        color: var(--text-primary);
        margin-bottom: 8px;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .preview-text {
        color: var(--text-primary);
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
        background: var(--bg-secondary);
        padding: 10px;
        border-radius: 5px;
        margin-top: 5px;
    }

    .preview-text.empty {
        color: var(--text-secondary);
        font-style: italic;
    }

    .preview-plan {
        background: rgba(33, 150, 243, 0.1);
        padding: 8px;
        border-radius: 5px;
        margin: 5px 0;
        border-left: 3px solid #2196F3;
    }

    .preview-plan-name {
        font-weight: bold;
        color: #4a9eff;
    }

    .preview-plan-value {
        color: #4CAF50;
        font-weight: bold;
        margin-left: 10px;
    }

    .preview-recovery-item {
        background: rgba(255, 152, 0, 0.1);
        padding: 8px;
        border-radius: 5px;
        margin: 5px 0;
        border-left: 3px solid #FF9800;
    }

    .preview-broadcast-item {
        background: rgba(156, 39, 176, 0.1);
        padding: 8px;
        border-radius: 5px;
        margin: 5px 0;
        border-left: 3px solid #9C27B0;
    }

    .preview-time {
        font-weight: bold;
        color: var(--text-primary);
    }

    .preview-loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }
    
    .filter-select {
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 14px;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    .refresh-btn {
        padding: 10px 20px;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .refresh-btn:hover {
        background: #1976D2;
    }
    
    .bots-list {
        display: grid;
        gap: 15px;
    }
    
    .bot-card {
        background: var(--bg-card);
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--shadow);
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--border-color);
    }
    
    .bot-info h3 {
        color: var(--text-primary);
        font-size: 18px;
        margin-bottom: 5px;
    }
    
    .bot-info .bot-name {
        color: #4a9eff;
        font-size: 14px;
        margin-bottom: 5px;
    }
    
    .bot-info p {
        color: var(--text-secondary);
        font-size: 13px;
    }
    
    .bot-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        margin-top: 5px;
    }
    
    .status-active {
        background: #4CAF50;
        color: white;
    }
    
    .status-inactive {
        background: #f44336;
        color: white;
    }
    
    .bot-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .view-btn, .ban-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        text-decoration: none;
    }
    
    .view-btn {
        background: #2196F3;
        color: white;
    }
    
    .view-btn:hover {
        background: #1976D2;
    }
    
    .ban-btn {
        background: #f44336;
        color: white;
    }
    
    .ban-btn:hover {
        background: #d32f2f;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }
    
    .empty-state {
        text-align: center;
        padding: 60px;
        color: var(--text-secondary);
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 30px;
        padding: 20px;
        background: var(--bg-card);
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--shadow);
        border: 1px solid var(--border-color);
    }
    
    .pagination button {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }
    
    .pagination button:hover:not(:disabled) {
        background: #2196F3;
        color: white;
        border-color: #2196F3;
    }
    
    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .pagination .page-btn.active {
        background: #2196F3;
        color: white;
        border-color: #2196F3;
    }
    
    .pagination .page-info {
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 4px;
        transform: translateX(400px);
        transition: transform 0.3s;
        z-index: 1000;
        box-shadow: 0 2px 8px var(--shadow);
    }
    
    .notification.show {
        transform: translateX(0);
    }
    
    .notification.success {
        background: #4CAF50;
        color: white;
    }
    
    .notification.error {
        background: #f44336;
        color: white;
    }

    /* Modal de Faturamento */
    .revenue-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        animation: fadeIn 0.3s;
    }

    .revenue-modal.show {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .revenue-modal-content {
        background: var(--bg-card);
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px var(--shadow);
        animation: slideIn 0.3s;
        border: 1px solid var(--border-color);
    }

    .revenue-modal-header {
        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .revenue-modal-header h2 {
        margin: 0;
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .revenue-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.3s;
    }

    .revenue-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .revenue-modal-body {
        padding: 20px;
    }

    .period-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .period-btn {
        padding: 8px 16px;
        border: 1px solid var(--border-color);
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s;
    }

    .period-btn:hover {
        background: var(--bg-primary);
    }

    .period-btn.active {
        background: #2196F3;
        color: white;
        border-color: #2196F3;
    }

    .revenue-stats {
        display: grid;
        gap: 15px;
    }

    .revenue-stats .stat-card {
        background: var(--bg-secondary);
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #2196F3;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 12px;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: var(--text-primary);
    }

    .stat-value.revenue {
        color: #4CAF50;
    }

    .stat-value.fee {
        color: #FF9800;
        font-size: 20px;
    }

    .stat-value.sales {
        color: #2196F3;
    }

    .stat-value.ticket {
        color: #9C27B0;
    }

    .revenue-loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .revenue-error {
        text-align: center;
        padding: 20px;
        color: #f44336;
        background: rgba(244, 67, 54, 0.1);
        border-radius: 8px;
        margin: 20px;
    }

    .revenue-btn {
        padding: 8px 16px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        text-decoration: none;
        margin-left: 5px;
    }

    .revenue-btn:hover {
        background: #45a049;
    }

    /* Estilos para ajuste de taxa */
    .tax-adjust-section {
        border-top: 1px solid var(--border-color);
        margin-top: 20px;
        padding-top: 20px;
    }

    .current-tax {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        text-align: center;
        font-size: 16px;
    }

    .tax-btn {
        padding: 12px 20px;
        background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
        transition: transform 0.2s;
    }

    .tax-btn:hover {
        transform: translateY(-2px);
    }

    .tax-slider-container {
        background: var(--bg-secondary);
        padding: 20px;
        border-radius: 8px;
        margin-top: 15px;
    }

    .tax-slider {
        width: 100%;
        -webkit-appearance: none;
        height: 8px;
        border-radius: 5px;
        background: linear-gradient(to right, #4CAF50 0%, #FFC107 50%, #f44336 100%);
        outline: none;
        margin: 20px 0;
    }

    .tax-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: white;
        border: 3px solid #2196F3;
        cursor: pointer;
        box-shadow: 0 2px 8px var(--shadow);
    }

    .tax-slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: white;
        border: 3px solid #2196F3;
        cursor: pointer;
        box-shadow: 0 2px 8px var(--shadow);
    }

    .tax-display {
        text-align: center;
        font-size: 32px;
        font-weight: bold;
        color: #4a9eff;
        margin: 10px 0;
    }

    .tax-info {
        display: flex;
        justify-content: space-between;
        color: var(--text-secondary);
        font-size: 13px;
        margin-top: 10px;
    }

    .tax-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .tax-save-btn, .tax-cancel-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }

    .tax-save-btn {
        background: #4CAF50;
        color: white;
    }

    .tax-save-btn:hover {
        background: #45a049;
    }

    .tax-cancel-btn {
        background: #f44336;
        color: white;
    }

    .tax-cancel-btn:hover {
        background: #da190b;
    }

    /* Modal de Mensagem */
    .message-modal {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        animation: fadeIn 0.3s;
    }

    .message-modal.show {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .message-modal-content {
        background: var(--bg-card);
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px var(--shadow);
        animation: slideIn 0.3s;
        border: 1px solid var(--border-color);
    }

    .message-modal-header {
        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .message-modal-body {
        padding: 20px;
        background: var(--bg-card);
    }

    .message-textarea {
        width: 100%;
        min-height: 150px;
        padding: 12px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        font-family: Arial, sans-serif;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .message-textarea:focus {
        outline: none;
        border-color: #2196F3;
    }

    .template-selector {
        margin-bottom: 15px;
    }

    .template-selector select {
        width: 100%;
        padding: 10px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .message-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .send-msg-btn {
        flex: 1;
        padding: 12px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        font-weight: bold;
        transition: all 0.3s;
    }

    .send-msg-btn:hover {
        background: #45a049;
    }

    .cancel-msg-btn {
        flex: 1;
        padding: 12px;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        transition: all 0.3s;
    }

    .cancel-msg-btn:hover {
        background: #da190b;
    }

    .char-counter {
        text-align: right;
        color: var(--text-secondary);
        font-size: 12px;
        margin-top: 5px;
    }

    .message-btn {
        padding: 8px 16px;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        margin-left: 5px;
        transition: all 0.3s;
    }

    .message-btn:hover {
        background: #1976D2;
        transform: translateY(-1px);
    }

    /* Modal de Links VIP */
    .links-modal {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        animation: fadeIn 0.3s;
    }

    .links-modal.show {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .links-modal-content {
        background: var(--bg-card);
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px var(--shadow);
        animation: slideIn 0.3s;
        border: 1px solid var(--border-color);
    }

    .links-modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .links-modal-header h2 {
        margin: 0;
        font-size: 18px;
    }

    .links-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.3s;
    }

    .links-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .links-modal-body {
        padding: 20px;
        background: var(--bg-card);
    }

    .groups-loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .groups-list {
        display: grid;
        gap: 15px;
    }

    .group-card {
        background: var(--bg-secondary);
        border-radius: 10px;
        padding: 15px;
        border-left: 4px solid #667eea;
        transition: transform 0.2s;
    }

    .group-card:hover {
        transform: translateX(5px);
    }

    .group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .group-title {
        font-size: 16px;
        font-weight: bold;
        color: var(--text-primary);
    }

    .group-info {
        color: var(--text-secondary);
        font-size: 13px;
        margin-bottom: 10px;
    }

    .group-id {
        font-family: monospace;
        background: var(--bg-primary);
        padding: 2px 6px;
        border-radius: 4px;
    }

    .generate-link-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
        transition: transform 0.2s;
    }

    .generate-link-btn:hover {
        transform: translateY(-2px);
    }

    .generate-link-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .link-result {
        margin-top: 15px;
        padding: 15px;
        background: rgba(76, 175, 80, 0.1);
        border-radius: 8px;
        border: 1px solid #4caf50;
    }

    .link-url {
        background: var(--bg-primary);
        padding: 10px;
        border-radius: 4px;
        word-break: break-all;
        font-family: monospace;
        font-size: 12px;
        margin: 10px 0;
        border: 1px dashed #4caf50;
        color: var(--text-primary);
    }

    .link-info {
        display: flex;
        justify-content: space-between;
        color: var(--text-secondary);
        font-size: 12px;
        margin-top: 10px;
    }

    .copy-link-btn {
        background: #4caf50;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        width: 100%;
        margin-top: 10px;
    }

    .copy-link-btn:hover {
        background: #45a049;
    }

    .no-groups {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .links-btn {
        padding: 8px 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        margin-left: 5px;
        transition: all 0.3s;
    }

    .links-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>
</head>
<body>
   <div class="header">
       <h1>Gerenciamento de Bots</h1>
       <a href="/" class="back-btn">Voltar</a>
   </div>
   
   <div class="container">
       <div class="stats">
           <div class="stat-card">
               <h2 id="total-bots">0</h2>
               <p>Total de Bots</p>
           </div>
           <div class="stat-card">
               <h2 id="active-bots">0</h2>
               <p>Bots Ativos</p>
           </div>
           <div class="stat-card">
               <h2 id="inactive-bots">0</h2>
               <p>Bots Inativos</p>
           </div>
       </div>
       
       <div class="controls">
           <div class="search-box">
               <input type="text" id="search" placeholder="Buscar por username, ID ou owner...">
           </div>
           <select id="filter" class="filter-select">
               <option value="all">Todos</option>
               <option value="active">Ativos</option>
               <option value="inactive">Inativos</option>
           </select>
           <button class="refresh-btn" onclick="loadBots()">Atualizar</button>
       </div>
       
       <div id="bots-list" class="bots-list">
           <div class="loading">Carregando bots...</div>
       </div>
       
       <div id="pagination" class="pagination" style="display: none;">
           <button id="prev-btn" onclick="changePage(currentPage - 1)">‚Üê Anterior</button>
           <div id="page-numbers"></div>
           <button id="next-btn" onclick="changePage(currentPage + 1)">Pr√≥xima ‚Üí</button>
       </div>
   </div>
   
   <div id="notification" class="notification"></div>

   <!-- Modal de Faturamento -->
   <div id="revenueModal" class="revenue-modal">
       <div class="revenue-modal-content">
           <div class="revenue-modal-header">
               <h2>
                   üìä FATURAMENTO DO BOT
                   <span id="revenue-bot-name"></span>
               </h2>
               <button class="revenue-close" onclick="closeRevenueModal()">&times;</button>
           </div>
           <div class="revenue-modal-body">
               <div class="period-selector">
                   <button class="period-btn active" data-period="today">Hoje</button>
                   <button class="period-btn" data-period="yesterday">Ontem</button>
                   <button class="period-btn" data-period="this_week">Esta Semana</button>
                   <button class="period-btn" data-period="last_week">Semana Passada</button>
                   <button class="period-btn" data-period="this_month">Este M√™s</button>
                   <button class="period-btn" data-period="last_month">M√™s Passado</button>
                   <button class="period-btn" data-period="total">Total (3 meses)</button>
               </div>
               
               <div id="revenue-content">
                   <div class="revenue-loading">Carregando...</div>
               </div>
               
               <!-- Se√ß√£o de Ajuste de Taxa -->
               <div class="tax-adjust-section">
                   <div class="current-tax" id="current-tax-display">
                       Taxa atual: <strong>1.0%</strong>
                   </div>
                   <button class="tax-btn" onclick="showTaxAdjust()">
                       ‚öôÔ∏è Ajustar Taxa do Bot
                   </button>
                   
                   <div id="tax-adjust-form" style="display: none;">
                       <div class="tax-slider-container">
                           <div class="tax-display" id="tax-slider-value">1.0%</div>
                           <input type="range" 
                                  id="tax-slider" 
                                  class="tax-slider"
                                  min="0" 
                                  max="100" 
                                  value="10"
                                  oninput="updateTaxDisplay(this.value)">
                           <div class="tax-info">
                               <span>0%</span>
                               <span id="tax-example">A cada R$ 100: NGK recebe R$ 1.00</span>
                               <span>10%</span>
                           </div>
                           <div class="tax-actions">
                               <button class="tax-save-btn" onclick="saveTax()">‚úÖ Salvar Taxa</button>
                               <button class="tax-cancel-btn" onclick="hideTaxAdjust()">‚ùå Cancelar</button>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <!-- Modal de Enviar Mensagem -->
   <div id="messageModal" class="message-modal">
       <div class="message-modal-content">
           <div class="message-modal-header">
               <h2>üí¨ Enviar Mensagem para o Bot</h2>
               <button class="revenue-close" onclick="closeMessageModal()">&times;</button>
           </div>
           <div class="message-modal-body">
               <div class="template-selector">
                   <label for="template-select" style="font-weight: bold; margin-bottom: 5px; display: block;">
                       üìã Usar Template (opcional):
                   </label>
                   <select id="template-select" onchange="loadTemplate(this.value)">
                       <option value="">-- Selecione um template --</option>
                       <option value="copy_agressiva">‚ö†Ô∏è Copy Agressiva</option>
                       <option value="sem_gateway">üî¥ Sem Gateway</option>
                       <option value="manutencao">üîß Manuten√ß√£o</option>
                       <option value="aviso_banimento">üö´ Pr√©-Banimento</option>
                       <option value="taxa_ajustada">üí∞ Taxa Ajustada</option>
                   </select>
               </div>
               
               <div style="margin-top: 15px;">
                   <label for="message-text" style="font-weight: bold; margin-bottom: 5px; display: block;">
                       ‚úèÔ∏è Mensagem:
                   </label>
                   <textarea 
                       id="message-text" 
                       class="message-textarea"
                       placeholder="Digite sua mensagem aqui..."
                       oninput="updateCharCounter()"
                   ></textarea>
                   <div class="char-counter" id="char-counter">0 / 4096 caracteres</div>
               </div>
               
               <div style="margin-top: 15px; padding: 15px; background: #f0f0f0; border-radius: 8px;">
                   <strong>‚ÑπÔ∏è Informa√ß√µes:</strong><br>
                   <span style="font-size: 13px; color: #666;">
                       ‚Ä¢ A mensagem ser√° enviada atrav√©s do bot do cliente<br>
                       ‚Ä¢ O dono receber√° no Telegram dele<br>
                       ‚Ä¢ Ficar√° identificada como mensagem da administra√ß√£o<br>
                       ‚Ä¢ Ser√° registrada no hist√≥rico
                   </span>
               </div>
               
               <div class="message-actions">
                   <button class="send-msg-btn" onclick="sendMessage()">
                       üì§ Enviar Mensagem
                   </button>
                   <button class="cancel-msg-btn" onclick="closeMessageModal()">
                       ‚ùå Cancelar
                   </button>
               </div>
           </div>
       </div>
   </div>

   <!-- Modal de Links VIP -->
   <div id="linksModal" class="links-modal">
       <div class="links-modal-content">
           <div class="links-modal-header">
               <h2>üîó GRUPOS VIP DO BOT <span id="links-bot-name"></span></h2>
               <button class="links-close" onclick="closeLinksModal()">&times;</button>
           </div>
           <div class="links-modal-body">
               <div id="groups-loading" class="groups-loading">
                   Carregando grupos...
               </div>
               <div id="groups-list" class="groups-list" style="display: none;">
                   <!-- Grupos ser√£o inseridos aqui via JavaScript -->
               </div>
               <div id="no-groups" class="no-groups" style="display: none;">
                   <p>‚ö†Ô∏è Nenhum grupo VIP configurado neste bot.</p>
               </div>
           </div>
       </div>
   </div>
   
   <script>
    let allBots = [];
    let filteredBots = [];
    let currentPage = 1;
    const botsPerPage = 10;
    let searchTimeout;
    let currentBotId = null;
    let currentPeriod = 'today';
    let currentBotTax = 1;
    
    // Vari√°veis globais para o modal de mensagem
    let currentMessageBotId = null;
    let currentMessageBotUsername = null;
    let currentMessageOwnerId = null;
    let messageTemplates = {};
    
    // Vari√°veis globais para o modal de links
    let currentLinksBotId = null;
    let currentLinksBotUsername = null;
    let previewCache = {};
    let previewTimeout = null;
    let currentPreviewBotId = null;
    let isOverTooltip = false;  // ADICIONAR ESTA LINHA
    let isOverCard = false;     // ADICIONAR ESTA LINHA
    
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    
   async function loadBots() {
       const startTime = performance.now();
       
       try {
           const controller = new AbortController();
           const timeoutId = setTimeout(() => controller.abort(), 30000); // Timeout de 30 segundos
           
           // USA O NOVO ENDPOINT OTIMIZADO
           console.log('üöÄ [OPTIMIZED] Iniciando carregamento de bots...');
           const response = await fetch('/api/bots/active/optimized', {
               signal: controller.signal,
               headers: {
                   'Content-Type': 'application/json',
               }
           });
           
           clearTimeout(timeoutId);
           
           if (!response.ok) {
               throw new Error(`HTTP error! status: ${response.status}`);
           }
           
           const data = await response.json();
           
           if (!Array.isArray(data)) {
               throw new Error('Resposta inv√°lida do servidor');
           }
           
           // TAXA J√Å VEM DO BACKEND - N√ÉO PRECISA BUSCAR AQUI
           allBots = data;
           updateStats();
           applyFilters();
           
           const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
           console.log(`‚úÖ [OPTIMIZED] ${allBots.length} bots carregados em ${elapsed} segundos`);
           
           // Notifica√ß√£o de sucesso
           showNotification(`${allBots.length} bots carregados em ${elapsed}s`, 'success');
           
       } catch (error) {
           const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
           
           if (error.name === 'AbortError') {
               console.error(`‚è±Ô∏è [OPTIMIZED] Timeout ap√≥s ${elapsed} segundos`);
               showNotification('Timeout - Tentando novamente com cache...', 'error');
               
               // Tenta novamente ap√≥s 2 segundos (provavelmente pegar√° do cache)
               setTimeout(() => {
                   console.log('üîÑ [OPTIMIZED] Segunda tentativa...');
                   loadBots();
               }, 2000);
           } else {
               console.error(`‚ùå [OPTIMIZED] Erro ap√≥s ${elapsed} segundos:`, error);
               showNotification('Erro ao carregar bots', 'error');
           }
           
           // Mant√©m dados anteriores se existirem
           if (allBots.length > 0) {
               console.log(`‚ÑπÔ∏è [OPTIMIZED] Mantendo ${allBots.length} bots em mem√≥ria`);
           }
       }
   }
    
    function updateStats() {
        const total = allBots.length;
        const active = allBots.filter(b => b.status === 'active').length;
        const inactive = allBots.filter(b => b.status === 'inactive').length;
        
        document.getElementById('total-bots').textContent = total;
        document.getElementById('active-bots').textContent = active;
        document.getElementById('inactive-bots').textContent = inactive;
    }
    
    function applyFilters() {
        const searchTerm = document.getElementById('search').value.toLowerCase();
        const filterValue = document.getElementById('filter').value;
        
        filteredBots = allBots.filter(bot => {
            const matchesSearch = !searchTerm || 
                bot.username.toLowerCase().includes(searchTerm) ||
                bot.id.includes(searchTerm) ||
                bot.owner.includes(searchTerm) ||
                (bot.name && bot.name.toLowerCase().includes(searchTerm));
            
            let matchesFilter = true;
            if (filterValue === 'active') {
                matchesFilter = bot.status === 'active';
            } else if (filterValue === 'inactive') {
                matchesFilter = bot.status === 'inactive';
            }
            
            return matchesSearch && matchesFilter;
        });
        
        currentPage = 1;
        renderBots();
        renderPagination();
    }
    
   function renderBots() {
       const startIndex = (currentPage - 1) * botsPerPage;
       const endIndex = startIndex + botsPerPage;
       const botsToShow = filteredBots.slice(startIndex, endIndex);
       
       const listElement = document.getElementById('bots-list');
       
       if (filteredBots.length === 0) {
           listElement.innerHTML = `
               <div class="empty-state">
                   <h3>Nenhum bot encontrado</h3>
                   <p>Tente ajustar os filtros de busca</p>
               </div>
           `;
           document.getElementById('pagination').style.display = 'none';
           return;
       }
       
       listElement.innerHTML = botsToShow.map(bot => {
           const botName = bot.name || 'Sem nome';
           const botUsername = bot.username || 'indefinido';
           const botId = bot.id || 'sem_id';
           const botOwner = bot.owner || 'desconhecido';
           const botToken = bot.token ? bot.token.substring(0, 15) : 'token_invalido';
           const botStatus = bot.status || 'inactive';
           const botTaxType = bot.tax_type || 'percentage';
           
           const taxBadge = botTaxType === 'fixed' 
               ? '<span style="background: #FF9800; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 5px;">TAXA FIXA</span>'
               : '<span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 5px;">TAXA %</span>';
           
           return `
               <div class="bot-card"
                    onmouseenter="showPreview('${botId}', event)"
                    onmousemove="showPreview('${botId}', event)"
                    onmouseleave="hidePreview()">
                   <div class="bot-info">
                       <h3>${botName} ${taxBadge}</h3>
                       <div class="bot-name">@${botUsername}</div>
                       <p>ID: ${botId} ‚Ä¢ Owner: ${botOwner} ‚Ä¢ Token: ${botToken}...</p>
                       <span class="bot-status status-${botStatus}">
                           ${botStatus === 'active' ? 'Ativo' : 'Inativo'}
                       </span>
                   </div>
                   <div class="bot-actions">
                       <a href="https://t.me/${botUsername}" target="_blank" class="view-btn">
                           Ver Bot
                       </a>
                       <button class="revenue-btn" onclick="openRevenueModal('${botId}', '@${botUsername}')">
                           Ver Faturamento
                       </button>
                       <button class="message-btn" onclick="openMessageModal('${botId}', '@${botUsername}', '${botOwner}')">
                           üí¨ Enviar Mensagem
                       </button>
                       <button class="links-btn" onclick="openLinksModal('${botId}', '@${botUsername}')">
                           üîó Ver Grupos
                       </button>
                       <button class="ban-btn" onclick="banBot('${botId}')">
                           Banir
                       </button>
                   </div>
               </div>
           `;
       }).join('');
   }
    
    function renderPagination() {
        const totalPages = Math.ceil(filteredBots.length / botsPerPage);
        const paginationElement = document.getElementById('pagination');
        
        if (totalPages <= 1) {
            paginationElement.style.display = 'none';
            return;
        }
        
        paginationElement.style.display = 'flex';
        
        const startIndex = (currentPage - 1) * botsPerPage;
        const endIndex = startIndex + botsPerPage;
        
        document.getElementById('prev-btn').disabled = currentPage === 1;
        document.getElementById('next-btn').disabled = currentPage === totalPages;
        
        const pageNumbers = document.getElementById('page-numbers');
        pageNumbers.innerHTML = '';
        
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        if (startPage > 1) {
            pageNumbers.innerHTML += `
                <button class="page-btn" onclick="changePage(1)">1</button>
                ${startPage > 2 ? '<span>...</span>' : ''}
            `;
        }
        
        for (let i = startPage; i <= endPage; i++) {
            pageNumbers.innerHTML += `
                <button class="page-btn ${i === currentPage ? 'active' : ''}" 
                        onclick="changePage(${i})">${i}</button>
            `;
        }
        
        if (endPage < totalPages) {
            pageNumbers.innerHTML += `
                ${endPage < totalPages - 1 ? '<span>...</span>' : ''}
                <button class="page-btn" onclick="changePage(${totalPages})">${totalPages}</button>
            `;
        }
        
        pageNumbers.innerHTML += `
            <span class="page-info">
                ${startIndex + 1}-${Math.min(endIndex, filteredBots.length)} de ${filteredBots.length}
            </span>
        `;
    }
    
    function changePage(page) {
        const totalPages = Math.ceil(filteredBots.length / botsPerPage);
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        renderBots();
        renderPagination();
        
        document.getElementById('bots-list').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    async function banBot(botId) {
        const bot = allBots.find(b => b.id === botId);
        if (!bot) return;
        
        const confirmMessage = `Tem certeza que deseja banir @${bot.username}?\n\nEsta a√ß√£o √© permanente.`;
        
        if (!confirm(confirmMessage)) return;
        
        try {
            const response = await fetch(`/api/bot/ban/${botId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) throw new Error('Erro ao banir bot');
            
            showNotification(`Bot @${bot.username} removido com sucesso`, 'success');
            
            await loadBots();
        } catch (error) {
            showNotification('Erro ao banir bot', 'error');
            console.error(error);
        }
    }
    
    // FUN√á√ïES DA MODAL DE FATURAMENTO
    async function openRevenueModal(botId, botUsername) {
        currentBotId = botId;
        currentPeriod = 'today';
        
        document.getElementById('revenue-bot-name').textContent = botUsername;
        
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.period === 'today') {
                btn.classList.add('active');
            }
        });
        
        await loadBotTax(botId);
        
        document.getElementById('revenueModal').classList.add('show');
        
        await loadRevenueData('today');
    }
    
    function closeRevenueModal() {
        document.getElementById('revenueModal').classList.remove('show');
        currentBotId = null;
        hideTaxAdjust();
    }
    
   async function loadRevenueData(period) {
       const contentDiv = document.getElementById('revenue-content');
       contentDiv.innerHTML = '<div class="revenue-loading">Carregando...</div>';
       
       try {
           const response = await fetch(`/api/bot/revenue/${currentBotId}?period=${period}`);
           
           if (!response.ok) {
               throw new Error('Erro ao carregar dados');
           }
           
           const data = await response.json();
           
           const totalRevenue = data.total_revenue.toLocaleString('pt-BR', {
               style: 'currency',
               currency: 'BRL'
           });
           
           const ngkFee = data.ngk_fee.toLocaleString('pt-BR', {
               style: 'currency',
               currency: 'BRL'
           });
           
           const avgTicket = data.avg_ticket.toLocaleString('pt-BR', {
               style: 'currency',
               currency: 'BRL'
           });
           
           // Pega o bot para ter o owner
           const bot = allBots.find(b => b.id === currentBotId);
           let taxLabel = "Taxa NGK";
           
           if (bot) {
               // Busca config de taxa do owner
               const taxResponse = await fetch(`/api/bot/owner-tax-type/${bot.owner}`);
               if (taxResponse.ok) {
                   const taxConfig = await taxResponse.json();
                   if (taxConfig.type === 'fixed') {
                       taxLabel = `Taxa NGK (R$ ${taxConfig.fixed_value.toFixed(2)}/venda)`;
                   } else {
                       taxLabel = `Taxa NGK (${taxConfig.percentage_value.toFixed(1)}%)`;
                   }
               }
           }
           
           contentDiv.innerHTML = `
               <div class="revenue-stats">
                   <div class="stat-card">
                       <div class="stat-label">Total Bruto</div>
                       <div class="stat-value revenue">${totalRevenue}</div>
                   </div>
                   
                   <div class="stat-card">
                       <div class="stat-label">${taxLabel}</div>
                       <div class="stat-value fee">${ngkFee}</div>
                   </div>
                   
                   <div class="stat-card">
                       <div class="stat-label">N¬∫ de Vendas</div>
                       <div class="stat-value sales">${data.num_sales}</div>
                   </div>
                   
                   <div class="stat-card">
                       <div class="stat-label">Ticket M√©dio</div>
                       <div class="stat-value ticket">${avgTicket}</div>
                   </div>
               </div>
           `;
           
       } catch (error) {
           console.error('Erro ao carregar faturamento:', error);
           contentDiv.innerHTML = `
               <div class="revenue-error">
                   Erro ao carregar dados de faturamento
               </div>
           `;
       }
   }
    
   async function loadBotTax(botId) {
       try {
           // Pega o bot e seu owner
           const bot = allBots.find(b => b.id === botId);
           if (!bot) return;
           
           // Pega a configura√ß√£o de taxa do owner
           const response = await fetch(`/api/bot/owner-tax-type/${bot.owner}`);
           if (response.ok) {
               const taxConfig = await response.json();
               
               if (taxConfig.type === 'fixed') {
                   // Para taxa fixa, mostra o valor fixo
                   currentBotTax = taxConfig.fixed_value;
                   document.getElementById('current-tax-display').innerHTML = 
                       `Taxa atual: <strong>R$ ${taxConfig.fixed_value.toFixed(2)}</strong> por venda`;
                   document.getElementById('main-tax-btn').innerHTML = 
                       `‚öôÔ∏è Ajustar Taxa Fixa`;
               } else {
                   // Para percentual, mostra a porcentagem
                   currentBotTax = taxConfig.percentage_value;
                   document.getElementById('current-tax-display').innerHTML = 
                       `Taxa atual: <strong>${taxConfig.percentage_value.toFixed(1)}%</strong>`;
                   document.getElementById('main-tax-btn').innerHTML = 
                       `‚öôÔ∏è Ajustar Taxa Percentual`;
               }
           }
       } catch (error) {
           console.error('Erro ao carregar taxa:', error);
       }
   }
    
    async function showTaxAdjust() {
        const taxForm = document.getElementById('tax-adjust-form');
        
        try {
            // Pega o owner do bot
            const bot = allBots.find(b => b.id === currentBotId);
            if (!bot) return;
            
            const response = await fetch(`/api/bot/owner-tax-type/${bot.owner}`);
            const taxConfig = await response.json();
            
            // Salva o owner_id para usar no save
            window.currentOwnerId = bot.owner;
            
            if (taxConfig.type === 'fixed') {
                // Interface para ajustar valor da taxa fixa
                taxForm.innerHTML = `
                    <div class="tax-slider-container">
                        <h4 style="color: #FF9800; margin-bottom: 15px;">üíµ Ajustar Valor da Taxa Fixa</h4>
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <label style="font-weight: bold;">Valor cobrado por venda (R$):</label>
                            <input type="number" 
                                id="tax-value-input" 
                                value="${taxConfig.fixed_value}" 
                                min="0" 
                                max="10" 
                                step="0.01"
                                style="width: 100%; padding: 10px; margin-top: 10px; border: 2px solid #FF9800; border-radius: 4px; font-size: 18px; text-align: center;"
                                oninput="updateTaxPreview('fixed', this.value)">
                            <div id="tax-preview" style="text-align: center; margin-top: 15px; font-size: 24px; color: #FF9800; font-weight: bold;">
                                R$ ${taxConfig.fixed_value.toFixed(2)} por venda
                            </div>
                            <div style="color: #666; font-size: 13px; margin-top: 10px; text-align: center;">
                                Exemplo: Em uma venda de R$ 100,00<br>
                                NGK recebe: R$ <span id="tax-example">${taxConfig.fixed_value.toFixed(2)}</span><br>
                                Cliente recebe: R$ <span id="client-example">${(100 - taxConfig.fixed_value).toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="tax-actions">
                            <button class="tax-save-btn" onclick="saveTaxValue('fixed')">‚úÖ Salvar Taxa Fixa</button>
                            <button class="tax-cancel-btn" onclick="hideTaxAdjust()">‚ùå Cancelar</button>
                        </div>
                    </div>
                `;
            } else {
                // Interface para ajustar valor da taxa percentual
                taxForm.innerHTML = `
                    <div class="tax-slider-container">
                        <h4 style="color: #4CAF50; margin-bottom: 15px;">üìä Ajustar Valor da Taxa Percentual</h4>
                        <div class="tax-display" id="tax-preview">${taxConfig.percentage_value.toFixed(1)}%</div>
                        <input type="range" 
                            id="tax-slider" 
                            class="tax-slider"
                            min="0" 
                            max="100" 
                            value="${taxConfig.percentage_value * 10}"
                            oninput="updateTaxPreview('percentage', this.value / 10)">
                        <div class="tax-info">
                            <span>0%</span>
                            <span id="tax-example">Em R$ 100: NGK recebe R$ ${(taxConfig.percentage_value).toFixed(2)}</span>
                            <span>10%</span>
                        </div>
                        <div class="tax-actions">
                            <button class="tax-save-btn" onclick="saveTaxValue('percentage')">‚úÖ Salvar Taxa %</button>
                            <button class="tax-cancel-btn" onclick="hideTaxAdjust()">‚ùå Cancelar</button>
                        </div>
                    </div>
                `;
            }
            
            taxForm.style.display = 'block';
            
        } catch (error) {
            console.error('Erro ao carregar configura√ß√£o de taxa:', error);
        }
    }

    function updateTaxPreview(type, value) {
        if (type === 'fixed') {
            const fixedValue = parseFloat(value) || 0;
            document.getElementById('tax-preview').textContent = `R$ ${fixedValue.toFixed(2)} por venda`;
            document.getElementById('tax-example').textContent = fixedValue.toFixed(2);
            document.getElementById('client-example').textContent = (100 - fixedValue).toFixed(2);
        } else {
            const percentValue = parseFloat(value) || 0;
            document.getElementById('tax-preview').textContent = `${percentValue.toFixed(1)}%`;
            const taxAmount = (100 * percentValue / 100).toFixed(2);
            document.getElementById('tax-example').textContent = `Em R$ 100: NGK recebe R$ ${taxAmount}`;
        }
    }

    async function saveTaxValue(type) {
        let newValue;
        
        if (type === 'fixed') {
            newValue = parseFloat(document.getElementById('tax-value-input').value);
            if (newValue < 0 || newValue > 10) {
                showNotification('Taxa fixa deve estar entre R$ 0,00 e R$ 10,00', 'error');
                return;
            }
        } else {
            newValue = parseFloat(document.getElementById('tax-slider').value) / 10;
            if (newValue < 0 || newValue > 10) {
                showNotification('Taxa percentual deve estar entre 0% e 10%', 'error');
                return;
            }
        }
        
        try {
            const response = await fetch(`/api/bot/owner-tax-value/${window.currentOwnerId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value: newValue })
            });
            
            if (response.ok) {
                const data = await response.json();
                
                if (type === 'fixed') {
                    document.getElementById('current-tax-display').innerHTML = 
                        `Taxa atual: <strong>R$ ${newValue.toFixed(2)}</strong> (fixa)`;
                } else {
                    document.getElementById('current-tax-display').innerHTML = 
                        `Taxa atual: <strong>${newValue.toFixed(1)}%</strong>`;
                }
                
                hideTaxAdjust();
                showNotification(data.message, 'success');
                
                // Recarrega os dados
                await loadRevenueData(currentPeriod);
            } else {
                throw new Error('Erro ao salvar taxa');
            }
        } catch (error) {
            showNotification('Erro ao salvar taxa', 'error');
            console.error('Erro:', error);
        }
    }
    
    function hideTaxAdjust() {
        document.getElementById('tax-adjust-form').style.display = 'none';
    }
    
    function updateTaxDisplay(value) {
        const taxPercentage = value / 10;
        document.getElementById('tax-slider-value').textContent = taxPercentage.toFixed(1) + '%';
        
        const taxAmount = (100 * taxPercentage / 100).toFixed(2);
        document.getElementById('tax-example').textContent = 
            `A cada R$ 100: NGK recebe R$ ${taxAmount}`;
    }
    
    async function saveTax() {
        const sliderValue = document.getElementById('tax-slider').value;
        const newTax = sliderValue / 10;
        
        try {
            const response = await fetch(`/api/bot/tax/${currentBotId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tax: newTax })
            });
            
            if (response.ok) {
                currentBotTax = newTax;
                document.getElementById('current-tax-display').innerHTML = 
                    `Taxa atual: <strong>${newTax.toFixed(1)}%</strong>`;
                hideTaxAdjust();
                showNotification(`Taxa atualizada para ${newTax.toFixed(1)}%`, 'success');
                
                await loadRevenueData(currentPeriod);
            } else {
                throw new Error('Erro ao salvar taxa');
            }
        } catch (error) {
            showNotification('Erro ao salvar taxa', 'error');
            console.error('Erro:', error);
        }
    }
    
    // FUN√á√ïES DO MODAL DE MENSAGEM
    function openMessageModal(botId, botUsername, ownerId) {
        currentMessageBotId = botId;
        currentMessageBotUsername = botUsername;
        currentMessageOwnerId = ownerId;
        
        document.querySelector('.message-modal-header h2').innerHTML = 
            `üí¨ Enviar Mensagem para ${botUsername}`;
        
        document.getElementById('template-select').value = '';
        document.getElementById('message-text').value = '';
        updateCharCounter();
        
        document.getElementById('messageModal').classList.add('show');
        
        if (Object.keys(messageTemplates).length === 0) {
            loadTemplatesFromServer();
        }
    }
    
    function closeMessageModal() {
        document.getElementById('messageModal').classList.remove('show');
        currentMessageBotId = null;
        currentMessageBotUsername = null;
        currentMessageOwnerId = null;
    }
    
    function loadTemplate(templateId) {
        if (!templateId) {
            document.getElementById('message-text').value = '';
            updateCharCounter();
            return;
        }
        
        const templates = {
            'copy_agressiva': `‚ö†Ô∏è AVISO - Conte√∫do Inadequado

Identificamos que seu bot est√° utilizando copy muito agressiva ou enganosa nas mensagens de venda.

Problema identificado:
- Promessas exageradas ou falsas
- Linguagem inadequada ou ofensiva

A√ß√£o necess√°ria:
Voc√™ tem 24 HORAS para adequar o conte√∫do do seu bot.

Caso n√£o seja feito, seu bot ser√° PERMANENTEMENTE BANIDO da plataforma.`,
            
            'sem_gateway': `üî¥ ATEN√á√ÉO - Gateway n√£o configurado

Seu bot ainda n√£o possui um gateway de pagamento configurado.

Sem isso, voc√™ N√ÉO conseguir√° receber pagamentos.

Como resolver:
1. Acesse seu bot
2. Use o comando /gateway
3. Configure sua forma de pagamento`,
            
            'manutencao': `üîß MANUTEN√á√ÉO PROGRAMADA

Informamos que realizaremos uma manuten√ß√£o no sistema.

Quando: Hoje, das 02:00 √†s 04:00 (Hor√°rio de Bras√≠lia)

O que pode acontecer:
- Seu bot pode ficar temporariamente offline
- Pagamentos podem demorar para processar

N√£o √© necess√°ria nenhuma a√ß√£o de sua parte.`,
            
            'aviso_banimento': `üö´ √öLTIMO AVISO - BANIMENTO IMINENTE

Este √© seu √öLTIMO AVISO antes do banimento permanente.

Voc√™ tem 2 HORAS para:
1. Corrigir o conte√∫do do seu bot
2. Entrar em contato com o suporte
3. Explicar as mudan√ßas realizadas

Ap√≥s este prazo, sem resposta, seu bot ser√° BANIDO PERMANENTEMENTE.`,
            
            'taxa_ajustada': `üí∞ AJUSTE DE TAXA

Informamos que sua taxa foi ajustada.

Nova taxa: [INSERIR TAXA]%
V√°lida a partir de: Agora

Se tiver d√∫vidas, entre em contato com o suporte.`
        };
        
        const template = templates[templateId];
        if (template) {
            document.getElementById('message-text').value = template;
            updateCharCounter();
        }
    }
    
    function updateCharCounter() {
        const textarea = document.getElementById('message-text');
        const counter = document.getElementById('char-counter');
        const length = textarea.value.length;
        
        counter.textContent = `${length} / 4096 caracteres`;
        
        if (length > 4096) {
            counter.style.color = '#f44336';
        } else if (length > 3500) {
            counter.style.color = '#FF9800';
        } else {
            counter.style.color = '#666';
        }
    }
    
    async function sendMessage() {
        const messageText = document.getElementById('message-text').value.trim();
        
        if (!messageText) {
            alert('‚ùå Por favor, digite uma mensagem!');
            return;
        }
        
        if (messageText.length > 4096) {
            alert('‚ùå A mensagem √© muito longa! M√°ximo 4096 caracteres.');
            return;
        }
        
        if (!confirm(`Tem certeza que deseja enviar esta mensagem para ${currentMessageBotUsername}?`)) {
            return;
        }
        
        const sendBtn = document.querySelector('.send-msg-btn');
        sendBtn.disabled = true;
        sendBtn.textContent = '‚è≥ Enviando...';
        
        try {
            const response = await fetch(`/api/bot/send-message/${currentMessageBotId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: messageText,
                    use_template: false
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('‚úÖ Mensagem enviada com sucesso!', 'success');
                closeMessageModal();
            } else {
                showNotification(`‚ùå Erro: ${data.error}`, 'error');
            }
            
        } catch (error) {
            console.error('Erro ao enviar mensagem:', error);
            showNotification('‚ùå Erro ao enviar mensagem', 'error');
        } finally {
            sendBtn.disabled = false;
            sendBtn.textContent = 'üì§ Enviar Mensagem';
        }
    }
    
    async function loadTemplatesFromServer() {
        try {
            const response = await fetch('/api/bot/templates');
            if (response.ok) {
                messageTemplates = await response.json();
            }
        } catch (error) {
            console.error('Erro ao carregar templates:', error);
        }
    }
    
    // FUN√á√ïES DO MODAL DE LINKS VIP
    async function openLinksModal(botId, botUsername) {
        currentLinksBotId = botId;
        currentLinksBotUsername = botUsername;
        
        document.getElementById('links-bot-name').textContent = botUsername;
        
        document.getElementById('linksModal').classList.add('show');
        
        document.getElementById('groups-loading').style.display = 'block';
        document.getElementById('groups-list').style.display = 'none';
        document.getElementById('no-groups').style.display = 'none';
        
        await loadBotGroups(botId);
    }
    
    function closeLinksModal() {
        document.getElementById('linksModal').classList.remove('show');
        currentLinksBotId = null;
        currentLinksBotUsername = null;
    }
    
    async function loadBotGroups(botId) {
        try {
            const response = await fetch(`/api/bot/groups/${botId}`);
            
            if (!response.ok) {
                throw new Error('Erro ao carregar grupos');
            }
            
            const data = await response.json();
            
            document.getElementById('groups-loading').style.display = 'none';
            
            if (data.groups && data.groups.length > 0) {
                document.getElementById('groups-list').style.display = 'block';
                renderGroups(data.groups);
            } else {
                document.getElementById('no-groups').style.display = 'block';
            }
            
        } catch (error) {
            console.error('Erro ao carregar grupos:', error);
            document.getElementById('groups-loading').innerHTML = 
                '<p style="color: #f44336;">‚ùå Erro ao carregar grupos</p>';
        }
    }
    
    function renderGroups(groups) {
        const listElement = document.getElementById('groups-list');
        
        listElement.innerHTML = groups.map(group => {
            const cardId = `group-card-${group.type}-${group.id}`;
            
            return `
                <div class="group-card" id="${cardId}">
                    <div class="group-header">
                        <span class="group-title">${group.icon} ${group.name}</span>
                    </div>
                    <div class="group-info">
                        ID: <span class="group-id">${group.id}</span>
                    </div>
                    <button class="generate-link-btn" 
                            onclick="generateLink('${group.id}', '${group.type}', '${cardId}')">
                        üîó Gerar Link de Acesso
                    </button>
                    <div id="link-result-${group.id}" style="display: none;"></div>
                </div>
            `;
        }).join('');
    }
    
   async function generateLink(groupId, groupType, cardId) {
           const button = document.querySelector(`#${cardId} .generate-link-btn`);
           const resultDiv = document.getElementById(`link-result-${groupId}`);
           
           button.disabled = true;
           button.textContent = '‚è≥ Gerando link...';
           
           try {
               const response = await fetch(`/api/bot/generate-link/${currentLinksBotId}`, {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json'
                   },
                   body: JSON.stringify({
                       group_id: groupId,
                       group_type: groupType
                   })
               });
               
               const data = await response.json();
               
               if (data.success) {
                   resultDiv.style.display = 'block';
                   resultDiv.innerHTML = `
                       <div class="link-result">
                           <strong>‚úÖ Link gerado com sucesso!</strong>
                           <div class="link-url">${data.link}</div>
                           <div class="link-info">
                               <span>‚è± V√°lido at√©: ${data.expires_at}</span>
                               <span>üë§ Limite: 1 uso</span>
                           </div>
                           <button class="copy-link-btn" onclick="copyLink('${data.link}')">
                               üìã Copiar Link
                           </button>
                       </div>
                   `;
                   
                   button.textContent = 'üîÑ Gerar Novo Link';
                   
               } else {
                   resultDiv.style.display = 'block';
                   resultDiv.innerHTML = `
                       <div style="padding: 10px; background: #ffebee; border-radius: 4px; margin-top: 10px;">
                           <strong style="color: #f44336;">‚ùå Erro:</strong><br>
                           ${data.error}
                       </div>
                   `;
                   
                   button.textContent = 'üîó Tentar Novamente';
               }
               
           } catch (error) {
               console.error('Erro ao gerar link:', error);
               
               resultDiv.style.display = 'block';
               resultDiv.innerHTML = `
                   <div style="padding: 10px; background: #ffebee; border-radius: 4px; margin-top: 10px;">
                       <strong style="color: #f44336;">‚ùå Erro ao gerar link</strong>
                   </div>
               `;
               
               button.textContent = 'üîó Tentar Novamente';
               
           } finally {
               button.disabled = false;
           }
       }

      // ========== FUN√á√ïES DE PREVIEW DE TEXTO ==========
      function showPreview(botId, event) {
          // Verifica se o mouse est√° sobre um bot√£o ou link
          const target = event.target;
          
          // Lista de classes e tags que devem bloquear o preview
          const blockingElements = ['BUTTON', 'A'];
          const blockingClasses = ['view-btn', 'revenue-btn', 'message-btn', 'links-btn', 'ban-btn', 'bot-actions'];
          
          // Verifica se o elemento atual ou algum pai √© um bot√£o/link
          let currentElement = target;
          while (currentElement && currentElement !== event.currentTarget) {
              // Verifica tag
              if (blockingElements.includes(currentElement.tagName)) {
                  clearTimeout(previewTimeout);
                  isOverCard = false;
                  return;
              }
              
              // Verifica classes
              for (let className of blockingClasses) {
                  if (currentElement.classList && currentElement.classList.contains(className)) {
                      clearTimeout(previewTimeout);
                      isOverCard = false;
                      return;
                  }
              }
              
              currentElement = currentElement.parentElement;
          }
          
          // Se chegou aqui, n√£o est√° sobre bot√£o
          
          // Se j√° tem um timeout rodando e o mouse continua no mesmo card, n√£o faz nada
          if (previewTimeout && isOverCard && currentPreviewBotId === botId) {
              return;
          }
          
          // Cancela timeout anterior se houver
          if (previewTimeout) {
              clearTimeout(previewTimeout);
          }
          
          // Marca que o mouse est√° sobre o card
          isOverCard = true;
          
          // Delay de 1 segundo
          previewTimeout = setTimeout(() => {
              if (isOverCard) {
                  loadPreview(botId, event);
              }
          }, 1000);
      }
   
   // ========== FUN√á√ÉO hidePreview COMPLETA ==========
   function hidePreview() {
       // Marca que o mouse saiu do card
       isOverCard = false;
       
       // Cancela timeout se existir
       if (previewTimeout) {
           clearTimeout(previewTimeout);
       }
       
       // Aguarda 100ms para verificar se o mouse foi para o tooltip
       setTimeout(() => {
           // S√≥ fecha se o mouse n√£o estiver nem no card nem no tooltip
           if (!isOverTooltip && !isOverCard) {
               document.getElementById('text-preview-tooltip').style.display = 'none';
               currentPreviewBotId = null;
           }
       }, 100);
   }

async function loadPreview(botId, event) {
    const tooltip = document.getElementById('text-preview-tooltip');
    const content = document.getElementById('preview-content');
    
    // Posiciona o tooltip ao lado do mouse
    const x = event.pageX + 20;
    const y = event.pageY - 100;
    
    // Ajusta posi√ß√£o se sair da tela
    const tooltipWidth = 500;
    const tooltipHeight = 400;
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    
    let finalX = x;
    let finalY = y;
    
    if (x + tooltipWidth > windowWidth) {
        finalX = event.pageX - tooltipWidth - 20;
    }
    
    if (y + tooltipHeight > windowHeight) {
        finalY = windowHeight - tooltipHeight - 20;
    }
    
    if (finalY < 20) {
        finalY = 20;
    }
    
    tooltip.style.left = finalX + 'px';
    tooltip.style.top = finalY + 'px';
    tooltip.style.display = 'block';
    
    currentPreviewBotId = botId;
    
    // Verifica cache
    if (previewCache[botId]) {
        renderPreview(previewCache[botId]);
        return;
    }
    
    // Mostra loading
    content.innerHTML = '<div class="preview-loading">Carregando textos...</div>';
    
    try {
        const response = await fetch(`/api/bot/preview-text/${botId}`);
        
        if (!response.ok) {
            throw new Error('Erro ao carregar preview');
        }
        
        const data = await response.json();
        
        // Salva no cache por 10 minutos
        previewCache[botId] = data;
        setTimeout(() => {
            delete previewCache[botId];
        }, 600000); // 10 minutos
        
        // Renderiza se ainda estiver mostrando o mesmo bot
        if (currentPreviewBotId === botId) {
            renderPreview(data);
        }
        
    } catch (error) {
        console.error('Erro ao carregar preview:', error);
        content.innerHTML = '<div style="padding: 20px; color: #f44336;">Erro ao carregar preview</div>';
    }
}

         function renderPreview(data) {
             const content = document.getElementById('preview-content');
             let html = '';
             
             // Se√ß√£o IN√çCIO
             if (data.inicio) {
                 html += '<div class="preview-section">';
                 html += '<div class="preview-section-title">üì± MENSAGEM INICIAL</div>';
                 
                 if (data.inicio.texto1) {
                     html += `<div class="preview-text">${escapeHtml(data.inicio.texto1)}</div>`;
                 }
                 
                 if (data.inicio.texto2) {
                     html += `<div class="preview-text">${escapeHtml(data.inicio.texto2)}</div>`;
                 }
                 
                 // Bot√£o do bot
                 if (data.inicio.button) {
                     html += `<div style="margin-top: 10px; padding: 10px; background: #2196F3; color: white; text-align: center; border-radius: 5px; font-weight: bold;">
                                 üõí ${escapeHtml(data.inicio.button)}
                              </div>`;
                 }
                 
                 if (!data.inicio.texto1 && !data.inicio.texto2) {
                     html += '<div class="preview-text empty">N√£o configurado</div>';
                 }
                 
                 html += '</div>';
             }
             
             // Se√ß√£o PLANOS
             if (data.planos && data.planos.length > 0) {
                 html += '<div class="preview-section">';
                 html += '<div class="preview-section-title">üí∞ PLANOS</div>';
                 
                 data.planos.forEach(plano => {
                     html += '<div class="preview-plan">';
                     html += `<span class="preview-plan-name">${escapeHtml(plano.nome)}</span>`;
                     html += `<span class="preview-plan-value">${plano.valor}</span>`;
                     if (plano.descricao) {
                         html += `<div style="font-size: 12px; color: #666; margin-top: 5px;">${escapeHtml(plano.descricao)}</div>`;
                     }
                     html += '</div>';
                 });
                 
                 html += '</div>';
             }
             
             // Se√ß√£o UPSELL
             if (data.upsell && data.upsell !== 'N√£o configurado') {
                 html += '<div class="preview-section">';
                 html += '<div class="preview-section-title">üöÄ UPSELL</div>';
                 html += `<div class="preview-text">${escapeHtml(data.upsell)}</div>`;
                 html += '</div>';
             }
             
             // Se√ß√£o DOWNSELL
             if (data.downsell && data.downsell !== 'N√£o configurado') {
                 html += '<div class="preview-section">';
                 html += '<div class="preview-section-title">üíî DOWNSELL</div>';
                 html += `<div class="preview-text">${escapeHtml(data.downsell)}</div>`;
                 html += '</div>';
             }
             
             // Se√ß√£o ORDERBUMPS
             if (data.orderbumps && data.orderbumps.length > 0) {
                 html += '<div class="preview-section">';
                 html += '<div class="preview-section-title">üéÅ ORDERBUMP</div>';
                 
                 data.orderbumps.forEach((bump, idx) => {
                     if (bump) {
                         html += `<div class="preview-text">${escapeHtml(bump)}</div>`;
                     }
                 });
                 
                 html += '</div>';
             }
             
             // Se√ß√£o RECUPERA√á√ÉO - CORRIGIDA
             if (data.recuperacao && data.recuperacao.length > 0) {
                 html += '<div class="preview-section">';
                 html += '<div class="preview-section-title">‚ôªÔ∏è RECUPERA√á√ÉO</div>';
                 
                 data.recuperacao.forEach(rec => {
                     if (rec && rec.texto) {
                         html += '<div class="preview-recovery-item">';
                         html += `<span class="preview-time">Ap√≥s ${rec.delay}:</span>`;
                         html += `<div style="margin-top: 5px; line-height: 1.4;">${escapeHtml(rec.texto)}</div>`;
                         html += '</div>';
                     }
                 });
                 
                 html += '</div>';
             }
             
             // Se√ß√£o DISPAROS
             if (data.disparos && data.disparos.length > 0) {
                 html += '<div class="preview-section">';
                 html += '<div class="preview-section-title">üì¢ DISPAROS PROGRAMADOS</div>';
                 
                 data.disparos.forEach(disparo => {
                     if (disparo && disparo.texto) {
                         html += '<div class="preview-broadcast-item">';
                         html += `<span class="preview-time">${disparo.horario}:</span>`;
                         html += `<div style="margin-top: 5px; line-height: 1.4;">${escapeHtml(disparo.texto)}</div>`;
                         html += '</div>';
                     }
                 });
                 
                 html += '</div>';
             }
             
             // Se√ß√£o ADEUS
             if (data.adeus && data.adeus !== 'N√£o configurado') {
                 html += '<div class="preview-section">';
                 html += '<div class="preview-section-title">üëã MENSAGEM DE ADEUS</div>';
                 html += `<div class="preview-text">${escapeHtml(data.adeus)}</div>`;
                 html += '</div>';
             }
             
             content.innerHTML = html || '<div style="padding: 20px; text-align: center; color: #999;">Nenhum texto configurado</div>';
         }
         
         function escapeHtml(text) {
             if (!text) return '';
             const div = document.createElement('div');
             div.textContent = text;
             return div.innerHTML;
         }
         // ========== FIM DAS FUN√á√ïES DE PREVIEW ==========
       
       function copyLink(link) {
           const tempInput = document.createElement('input');
           tempInput.value = link;
           document.body.appendChild(tempInput);
           tempInput.select();
           document.execCommand('copy');
           document.body.removeChild(tempInput);
           
           showNotification('‚úÖ Link copiado para a √°rea de transfer√™ncia!', 'success');
       }
       
       // Event listeners
       document.getElementById('search').addEventListener('input', (e) => {
           clearTimeout(searchTimeout);
           searchTimeout = setTimeout(() => applyFilters(), 300);
       });
       
       document.getElementById('filter').addEventListener('change', applyFilters);
       
       // Event listener para fechar modal clicando fora
       document.getElementById('revenueModal').addEventListener('click', (e) => {
           if (e.target.id === 'revenueModal') {
               closeRevenueModal();
           }
       });
       
       document.getElementById('messageModal').addEventListener('click', (e) => {
           if (e.target.id === 'messageModal') {
               closeMessageModal();
           }
       });
       
       document.getElementById('linksModal').addEventListener('click', (e) => {
           if (e.target.id === 'linksModal') {
               closeLinksModal();
           }
       });
       
       // Event listeners para os bot√µes de per√≠odo
       document.addEventListener('click', async (e) => {
           if (e.target.classList.contains('period-btn')) {
               document.querySelectorAll('.period-btn').forEach(btn => {
                   btn.classList.remove('active');
               });
               
               e.target.classList.add('active');
               
               const period = e.target.dataset.period;
               currentPeriod = period;
               await loadRevenueData(period);
           }
       });
       
       // Event listener para ESC fechar modals
       document.addEventListener('keydown', (e) => {
           if (e.key === 'Escape') {
               closeMessageModal();
               closeRevenueModal();
               closeLinksModal();
           }
       });
       
       // Carrega bots ao iniciar
       loadBots();
       
       // Atualiza a cada 30 segundos
       setInterval(loadBots, 120000); // Atualiza a cada 2 minutos ao inv√©s de 30 segundos
      </script>

      <div id="text-preview-tooltip" 
           class="text-preview-tooltip" 
           style="display: none;"
           onmouseenter="isOverTooltip = true"
           onmouseleave="isOverTooltip = false; hidePreview()">
          <div class="preview-header">
              <span class="preview-title">üìù Preview de Textos</span>
              <span class="preview-close" onclick="isOverTooltip = false; hidePreview()">√ó</span>
          </div>
          <div class="preview-body" id="preview-content">
              <div class="preview-loading">Carregando...</div>
          </div>
      </div>
   
   </body>
   </html>










